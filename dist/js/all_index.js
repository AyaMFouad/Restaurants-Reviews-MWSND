class DBHelper{static get DATABASE_URL(){return"http://localhost:1337"}static get RESTAURANT_URL(){return"http://localhost:1337/restaurants"}static get REVIEWS_URL(){return"http://localhost:1337/reviews/?restaurant_id="}static openDatabase(){return navigator.serviceWorker?idb.open("restaurants-db",1,function(e){e.createObjectStore("restaurants",{keyPath:"id"}).createIndex("rest-id","id"),e.createObjectStore("reviews",{keyPath:"id",autoIncrement:!0}).createIndex("restaurant_id","restaurant_id",{unique:!1}),e.createObjectStore("sync-reviews",{keyPath:"id",autoIncrement:!0}).createIndex("restaurant_id","restaurant_id",{unique:!1})}):(console.log("Browser doesn't support Service Workers"),Promise.resolve())}static fetchRestaurants(e){DBHelper.openDatabase().then(function(e){return e?e.transaction("restaurants","readwrite").objectStore("restaurants").getAll():void 0}).then(function(t){0!==t.length&&e(null,t)}),fetch(DBHelper.RESTAURANT_URL).then(function(t){200===t.status?t.json().then(function(t){DBHelper.openDatabase().then(function(e){if(e){let r=e.transaction("restaurants","readwrite"),n=r.objectStore("restaurants");return t.forEach(function(e){n.put(e)}),r.complete}}),e(null,t)}):console.log("Fetch Issue - Status Code: "+t.status)}).catch(function(e){console.log("Fetch Error: ",e)})}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t("Restaurant does not exist",null)}})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.cuisine_type==e);t(null,r)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.neighborhood==e);t(null,r)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchRestaurants((n,a)=>{if(n)r(n,null);else{let n=a;"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),r(null,n)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].neighborhood),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].cuisine_type),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static fetchReviews(e,t){DBHelper.openDatabase().then(function(t){if(t){return t.transaction("reviews","readwrite").objectStore("reviews").index("restaurant_id").getAll(parseInt(e))}}).then(function(e){0!==e.length&&t(null,e)}),fetch(`${DBHelper.REVIEWS_URL}${e}`).then(e=>e.json()).then(e=>{DBHelper.openDatabase().then(function(t){if(t){let r=t.transaction("reviews","readwrite"),n=r.objectStore("reviews");return e.forEach(function(e){n.put(e)}),r.complete}}),t(null,e)}).catch(e=>t(`Request failed. Returned ${e}`,null))}static fetchTmpReviews(e,t){DBHelper.openDatabase().then(function(t){if(t){return t.transaction("sync-reviews","readonly").objectStore("sync-reviews").index("restaurant_id").getAll(parseInt(e))}}).then(function(e){0!==e.length&&t(null,e)})}static postReview(e){return DBHelper.openDatabase().then(function(t){if(t){let r=t.transaction("sync-reviews","readwrite");return r.objectStore("sync-reviews").put(e),r.complete}}).then(function(){return Promise.resolve()}).catch(function(e){return console.log(e),Promise.resolve()})}static toggleFavorite(e,t){return DBHelper.openDatabase().then(function(e){if(e){return e.transaction("restaurants","readwrite").objectStore("restaurants").index("rest-id").openCursor()}}).then(function r(n){if(e=+e,n){if(n.value.id===e){var a=n.value;a.is_favorite=t,n.update(a).onsuccess=function(){}}return n.continue().then(r)}}).then(function(){fetch(`http://localhost:1337/restaurants/${e}/?is_favorite=${t}`,{method:"PUT"}).then(e=>e.json()).catch(e=>{console.log("Error fetching is_favorite: "+e)})}).then(function(){return Promise.resolve()})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/img/${e.photograph}.webp`}static imageResponsiveUrlForRestaurant(e){return`/img_responsive/${e.id}-320.webp 320w,\n        /img_responsive/${e.id}-480.webp 480w,\n        /img_responsive/${e.id}-640.webp 640w,\n        /img_responsive/${e.id}-800.webp 800w`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}}let restaurants,neighborhoods,cuisines;var map,markers=[];let observer=new IntersectionObserver(e=>{for(const t of e)t.intersecionRation>=.9&&DBHelper.fetchRestaurants((e,t)=>{e?console.error(e):fillRestaurantHTML(t)})},{threshold:[.9]});observer.observe(document.getElementById("restaurants-list"));const photographAlts={1:"Sereval groups of people having quality time at a restaurant.",2:"A lovely margeritta pizza",3:"An empty restaurant setting which has heaters",4:"A corner shot of the outside of the restaurat.",5:"A crowded restaurant and staff serving food from behind the bar.",6:"Restaurant with wooden tables, charis, and a US flag as a wall decoration",7:"a dog watching from the outside of a crowded burger shop, accompanied by two men.",8:"Close up of the dutch restaurant logo beside a flowering tree",9:"Black and white picture of people eating at an asian restaurat.",10:"Empty restaurant's white chairs, walls and ceilings."};document.addEventListener("DOMContentLoaded",e=>{fetchNeighborhoods(),fetchCuisines()}),fetchNeighborhoods=(()=>{DBHelper.fetchNeighborhoods((e,t)=>{e?console.error(e):(self.neighborhoods=t,fillNeighborhoodsHTML())})}),fillNeighborhoodsHTML=((e=self.neighborhoods)=>{const t=document.getElementById("neighborhoods-select");e.forEach(e=>{const r=document.createElement("option");r.innerHTML=e,r.value=e,t.append(r)})}),fetchCuisines=(()=>{DBHelper.fetchCuisines((e,t)=>{e?console.error(e):(self.cuisines=t,fillCuisinesHTML())})}),fillCuisinesHTML=((e=self.cuisines)=>{const t=document.getElementById("cuisines-select");e.forEach(e=>{const r=document.createElement("option");r.innerHTML=e,r.value=e,t.append(r)})}),window.initMap=(()=>{document.getElementById("map"),self.map=new google.maps.Map(document.getElementById("map"),{zoom:12,center:{lat:40.722216,lng:-73.987501},scrollwheel:!1}),updateRestaurants()}),callMap=document.getElementById("mapToggle").addEventListener("click",function(e){"block"===document.getElementById("map-container").style.display?(document.getElementById("map-container").style.display="none",window.initMap()):document.getElementById("map-container").style.display="block"}),updateRestaurants=(()=>{const e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),r=e.selectedIndex,n=t.selectedIndex,a=e[r].value,s=t[n].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(a,s,(e,t)=>{e?console.error(e):(resetRestaurants(t),fillRestaurantsHTML())})}),resetRestaurants=(e=>{self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.markers.forEach(e=>e.setMap(null)),self.markers=[],self.restaurants=e}),fillRestaurantsHTML=((e=self.restaurants)=>{const t=document.getElementById("restaurants-list");e.forEach(e=>{t.append(createRestaurantHTML(e))}),addMarkersToMap()}),createRestaurantHTML=(e=>{const t=document.createElement("li");t.tabIndex="0";const r=document.createElement("img");r.className="restaurant-img",r.src=DBHelper.imageUrlForRestaurant(e),r.srcset=DBHelper.imageResponsiveUrlForRestaurant(e),r.alt=photographAlts[e.id],t.append(r);const n=document.createElement("h2");n.innerHTML=e.name,t.append(n);const a=document.createElement("p");a.innerHTML=e.neighborhood,t.append(a);const s=document.createElement("p");s.innerHTML=e.address,t.append(s);const o=document.createElement("div");o.setAttribute("class","wrapper"),t.append(o);const i=document.createElement("a");i.innerHTML="View Details",i.href=DBHelper.urlForRestaurant(e),o.append(i);const l=document.createElement("i"),c="true"==e.is_favorite?"fas":"far";return l.setAttribute("id",`rest${e.id}`),l.setAttribute("class",`${c} fa-heart fa-3x`),l.setAttribute("tabindex","0"),l.setAttribute("role","button"),"true"==e.is_favorite?l.setAttribute("aria-label",`Unmark ${e.name} as favorite`):l.setAttribute("aria-label",`Mark ${e.name} as favorite`),l.addEventListener("click",()=>{const t=l.getAttribute("id");toggleFav(t,e.name)}),l.addEventListener("keydown",t=>{if(13===t.keyCode){const t=l.getAttribute("id");toggleFav(t,e.name)}}),o.append(l),t}),toggleFav=((e,t)=>{const r=document.getElementById(e),n=r.classList.contains("far");r.classList.toggle("far"),r.classList.toggle("fas"),n?r.setAttribute("aria-label",`Mark ${t} as favorite`):r.setAttribute("aria-label",`Unmark ${t} as favorite`),DBHelper.toggleFavorite(e.slice(4),n).then(()=>{setTimeout(function(){updateRestaurants()},200)})}),addMarkersToMap=((e=self.restaurants)=>{e.forEach(e=>{const t=DBHelper.mapMarkerForRestaurant(e,self.map);google.maps.event.addListener(t,"click",()=>{window.location.href=t.url}),self.markers.push(t)})}),navigator.serviceWorker&&navigator.serviceWorker.register("sw.js").then(()=>console.log("Passed Test")),registerServiceWorker=(()=>{navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js").catch(function(){console.log("Something went wrong. ServiceWorker not registered")})}),registerServiceWorker();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIiwibWFpbi5qcyIsInJlZ2lzdGVyU2VydmljZVdvcmtlci5qcyJdLCJuYW1lcyI6WyJEQkhlbHBlciIsIkRBVEFCQVNFX1VSTCIsIlJFU1RBVVJBTlRfVVJMIiwiUkVWSUVXU19VUkwiLCJbb2JqZWN0IE9iamVjdF0iLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwiaWRiIiwib3BlbiIsInVwZ3JhZGVEYiIsImNyZWF0ZU9iamVjdFN0b3JlIiwia2V5UGF0aCIsImNyZWF0ZUluZGV4IiwiYXV0b0luY3JlbWVudCIsInVuaXF1ZSIsImNvbnNvbGUiLCJsb2ciLCJQcm9taXNlIiwicmVzb2x2ZSIsImNhbGxiYWNrIiwib3BlbkRhdGFiYXNlIiwidGhlbiIsImRiIiwidHJhbnNhY3Rpb24iLCJvYmplY3RTdG9yZSIsImdldEFsbCIsInJlc3RhdXJhbnRzIiwibGVuZ3RoIiwiZmV0Y2giLCJyZXNwb25zZSIsInN0YXR1cyIsImpzb24iLCJ0eCIsInN0b3JlUmVzdGF1cmFudHMiLCJmb3JFYWNoIiwicmVzdGF1cmFudCIsInB1dCIsImNvbXBsZXRlIiwiY2F0Y2giLCJlcnIiLCJpZCIsImZldGNoUmVzdGF1cmFudHMiLCJlcnJvciIsImZpbmQiLCJyIiwiY3Vpc2luZSIsInJlc3VsdHMiLCJmaWx0ZXIiLCJjdWlzaW5lX3R5cGUiLCJuZWlnaGJvcmhvb2QiLCJuZWlnaGJvcmhvb2RzIiwibWFwIiwidiIsImkiLCJ1bmlxdWVOZWlnaGJvcmhvb2RzIiwiaW5kZXhPZiIsImN1aXNpbmVzIiwidW5pcXVlQ3Vpc2luZXMiLCJpbmRleCIsInBhcnNlSW50IiwicmV2aWV3cyIsInN0b3JlUmV2aWV3cyIsInJldmlldyIsInJlc3RhdXJhbnRJZCIsInRvZ2dsZVZhbHVlIiwib3BlbkN1cnNvciIsInVwZGF0ZUZhdm9yaXRlIiwiY3Vyc29yIiwidmFsdWUiLCJ1cGRhdGVEYXRhIiwiaXNfZmF2b3JpdGUiLCJ1cGRhdGUiLCJvbnN1Y2Nlc3MiLCJjb250aW51ZSIsIm1ldGhvZCIsInBob3RvZ3JhcGgiLCJnb29nbGUiLCJtYXBzIiwiTWFya2VyIiwicG9zaXRpb24iLCJsYXRsbmciLCJ0aXRsZSIsIm5hbWUiLCJ1cmwiLCJ1cmxGb3JSZXN0YXVyYW50IiwiYW5pbWF0aW9uIiwiQW5pbWF0aW9uIiwiRFJPUCIsIm1hcmtlcnMiLCJvYnNlcnZlciIsIkludGVyc2VjdGlvbk9ic2VydmVyIiwiY2hhbmdlcyIsImNoYW5nZSIsImludGVyc2VjaW9uUmF0aW9uIiwiZGF0YSIsImZpbGxSZXN0YXVyYW50SFRNTCIsInRocmVzaG9sZCIsIm9ic2VydmUiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwicGhvdG9ncmFwaEFsdHMiLCIxIiwiMiIsIjMiLCI0IiwiNSIsIjYiLCI3IiwiOCIsIjkiLCIxMCIsImFkZEV2ZW50TGlzdGVuZXIiLCJldmVudCIsImZldGNoTmVpZ2hib3Job29kcyIsImZldGNoQ3Vpc2luZXMiLCJzZWxmIiwiZmlsbE5laWdoYm9yaG9vZHNIVE1MIiwic2VsZWN0Iiwib3B0aW9uIiwiY3JlYXRlRWxlbWVudCIsImlubmVySFRNTCIsImFwcGVuZCIsImZpbGxDdWlzaW5lc0hUTUwiLCJ3aW5kb3ciLCJpbml0TWFwIiwiTWFwIiwiem9vbSIsImNlbnRlciIsImxhdCIsImxuZyIsInNjcm9sbHdoZWVsIiwidXBkYXRlUmVzdGF1cmFudHMiLCJjYWxsTWFwIiwic3R5bGUiLCJkaXNwbGF5IiwiY1NlbGVjdCIsIm5TZWxlY3QiLCJjSW5kZXgiLCJzZWxlY3RlZEluZGV4IiwibkluZGV4IiwiZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kIiwicmVzZXRSZXN0YXVyYW50cyIsImZpbGxSZXN0YXVyYW50c0hUTUwiLCJtIiwic2V0TWFwIiwidWwiLCJjcmVhdGVSZXN0YXVyYW50SFRNTCIsImFkZE1hcmtlcnNUb01hcCIsImxpIiwidGFiSW5kZXgiLCJpbWFnZSIsImNsYXNzTmFtZSIsInNyYyIsImltYWdlVXJsRm9yUmVzdGF1cmFudCIsInNyY3NldCIsImltYWdlUmVzcG9uc2l2ZVVybEZvclJlc3RhdXJhbnQiLCJhbHQiLCJhZGRyZXNzIiwid3JhcHBlciIsInNldEF0dHJpYnV0ZSIsIm1vcmUiLCJocmVmIiwiZmF2b3JpdGUiLCJpc0Zhdm9yaXRlIiwicmVzdElkIiwiZ2V0QXR0cmlidXRlIiwidG9nZ2xlRmF2IiwiZSIsImtleUNvZGUiLCJyZXN0TmFtZSIsImVsZW1lbnQiLCJzZXRUb2dnbGUiLCJjbGFzc0xpc3QiLCJjb250YWlucyIsInRvZ2dsZSIsInRvZ2dsZUZhdm9yaXRlIiwic2xpY2UiLCJzZXRUaW1lb3V0IiwibWFya2VyIiwibWFwTWFya2VyRm9yUmVzdGF1cmFudCIsImFkZExpc3RlbmVyIiwibG9jYXRpb24iLCJwdXNoIiwicmVnaXN0ZXIiLCJyZWdpc3RlclNlcnZpY2VXb3JrZXIiXSwibWFwcGluZ3MiOiJNQUdNQSxTQU1KQywwQkFFRSxNQUFRLHdCQUVWQyw0QkFFQSxNQUFRLG9DQUdWQyx5QkFFRSxNQUFRLGdEQU1WQyxzQkFJRSxPQUFLQyxVQUFVQyxjQUtSQyxJQUFJQyxLQUFLLGlCQUFrQixFQUFHLFNBQVVDLEdBQ3RCQSxFQUFVQyxrQkFBa0IsZUFDakRDLFFBQVMsT0FFTUMsWUFBWSxVQUFXLE1BQ3JCSCxFQUFVQyxrQkFBa0IsV0FDN0NDLFFBQVMsS0FDVEUsZUFBZSxJQUVKRCxZQUFZLGdCQUNBLGlCQUNFRSxRQUFRLElBQ2JMLEVBQVVDLGtCQUFrQixnQkFDaERDLFFBQVMsS0FDVEUsZUFBZSxJQUVERCxZQUFZLGdCQUNILGlCQUNFRSxRQUFRLE9BdEJuQ0MsUUFBUUMsSUFBSywyQ0FDTkMsUUFBUUMsV0E4QmpCZCx3QkFBd0JlLEdBR3RCbkIsU0FBU29CLGVBQWVDLEtBQUssU0FBVUMsR0FDckMsT0FBS0EsRUFHSUEsRUFBR0MsWUFBWSxjQUFlLGFBQzNCQyxZQUFZLGVBQ1pDLGNBSlYsSUFNREosS0FBSyxTQUFVSyxHQUNXLElBQXZCQSxFQUFZQyxRQUNoQlIsRUFBUyxLQUFN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LEVBQVNHLGFBQWEsTUFDckNDLFVBQVVGLEVBQVFqSSxFQUFXK0MsU0FHakM0RSxFQUFRckMsT0FBT3lDLEdBRVJkLElBR1RrQixVQUFZLEVBQUNGLEVBQVFLLEtBQ25CLE1BQU1DLEVBQVV4RSxTQUFTQyxlQUFlaUUsR0FDbENPLEVBQVlELEVBQVFFLFVBQVVDLFNBQVMsT0FDN0NILEVBQVFFLFVBQVVFLE9BQU8sT0FDekJKLEVBQVFFLFVBQVVFLE9BQU8sT0FDckJILEVBQ0ZELEVBQVFYLGFBQWEscUJBQXNCVSxpQkFFM0NDLEVBQVFYLGFBQWEsdUJBQXdCVSxpQkFHL0N6SyxTQUFTK0ssZUFBZVgsRUFBT1ksTUFBTSxHQUFJTCxHQUFXdEosS0FBSyxLQUN2RDRKLFdBQVcsV0FDVDlDLHFCQUNDLFNBUVBnQixnQkFBa0IsRUFBQ3pILEVBQWN5RixLQUFLekYsZUFDcENBLEVBQVlRLFFBQVFDLElBRWxCLE1BQU0rSSxFQUFTbEwsU0FBU21MLHVCQUF1QmhKLEVBQVlnRixLQUFLaEUsS0FDaEV5QixPQUFPQyxLQUFLbUMsTUFBTW9FLFlBQVlGLEVBQVEsUUFBUyxLQUM3Q3ZELE9BQU8wRCxTQUFTcEIsS0FBT2lCLEVBQU8vRixNQUVoQ2dDLEtBQUszQixRQUFROEYsS0FBS0osT0FLbEI3SyxVQUFVQyxlQUNaRCxVQUFVQyxjQUFjaUwsU0FBUyxTQUM5QmxLLEtBQUssSUFBTU4sUUFBUUMsSUFBSSxnQkN4UjVCd0ssc0JBQXdCLE1BRWZuTCxVQUFVQyxlQUVmRCxVQUFVQyxjQUFjaUwsU0FBUyxVQUFVakosTUFBTSxXQUMvQ3ZCLFFBQVFDLElBQUksMERBSWhCd0siLCJmaWxlIjoiYWxsX2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvbW1vbiBkYXRhYmFzZSBoZWxwZXIgZnVuY3Rpb25zLlxyXG4gKi9cclxuY2xhc3MgREJIZWxwZXIge1xyXG5cclxuICAvKipcclxuICAgKiBEYXRhYmFzZSBVUkwuXHJcbiAgICogQ2hhbmdlIHRoaXMgdG8gcmVzdGF1cmFudHMuanNvbiBmaWxlIGxvY2F0aW9uIG9uIHlvdXIgc2VydmVyLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXQgREFUQUJBU0VfVVJMKCkge1xyXG4gICAgY29uc3QgcG9ydCA9IDEzMzc7XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fWA7XHJcbiAgfVxyXG4gIHN0YXRpYyBnZXQgUkVTVEFVUkFOVF9VUkwoKSB7XHJcbiAgY29uc3QgcG9ydCA9IDEzMzc7XHJcbiAgcmV0dXJuIGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH0vcmVzdGF1cmFudHNgO1xyXG59XHJcblxyXG5zdGF0aWMgZ2V0IFJFVklFV1NfVVJMKCkge1xyXG4gIGNvbnN0IHBvcnQgPSAxMzM3O1xyXG4gIHJldHVybiBgaHR0cDovL2xvY2FsaG9zdDoke3BvcnR9L3Jldmlld3MvP3Jlc3RhdXJhbnRfaWQ9YDtcclxufVxyXG5cclxuLy8gSURCIGNyZWF0aW9uXHJcblxyXG5cclxuc3RhdGljIG9wZW5EYXRhYmFzZSAoKSB7XHJcblxyXG4gIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBzZXJ2aWNlIHdvcmtlcixcclxuICAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGhhdmluZyBhIGRhdGFiYXNlXHJcbiAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlcikge1xyXG4gICAgY29uc29sZS5sb2coYEJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IFNlcnZpY2UgV29ya2Vyc2ApO1xyXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGlkYi5vcGVuKCdyZXN0YXVyYW50cy1kYicsIDEsIGZ1bmN0aW9uICh1cGdyYWRlRGIpIHtcclxuICAgIHZhciBzdG9yZVJlc3RhdXJhbnRzID0gdXBncmFkZURiLmNyZWF0ZU9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycsIHtcclxuICAgICAga2V5UGF0aDogJ2lkJyxcclxuICAgIH0pO1xyXG4gICAgc3RvcmVSZXN0YXVyYW50cy5jcmVhdGVJbmRleCgncmVzdC1pZCcsICdpZCcpO1xyXG4gICAgdmFyIHN0b3JlUmV2aWV3cyA9IHVwZ3JhZGVEYi5jcmVhdGVPYmplY3RTdG9yZSgncmV2aWV3cycsIHtcclxuICAgICAga2V5UGF0aDogJ2lkJyxcclxuICAgICAgYXV0b0luY3JlbWVudDogdHJ1ZSxcclxuICAgIH0pO1xyXG4gICAgc3RvcmVSZXZpZXdzLmNyZWF0ZUluZGV4KCdyZXN0YXVyYW50X2lkJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAncmVzdGF1cmFudF9pZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB1bmlxdWU6IGZhbHNlIH0pO1xyXG4gICAgdmFyIHN0b3JlU3luY1JldmlldyA9IHVwZ3JhZGVEYi5jcmVhdGVPYmplY3RTdG9yZSgnc3luYy1yZXZpZXdzJywge1xyXG4gICAgICBrZXlQYXRoOiAnaWQnLFxyXG4gICAgICBhdXRvSW5jcmVtZW50OiB0cnVlLFxyXG4gICAgfSk7XHJcbiAgICBzdG9yZVN5bmNSZXZpZXcuY3JlYXRlSW5kZXgoJ3Jlc3RhdXJhbnRfaWQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyZXN0YXVyYW50X2lkJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHVuaXF1ZTogZmFsc2UgfSk7XHJcbiAgfSk7XHJcbn1cclxuXHJcblxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgcmVzdGF1cmFudHMuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudHMoY2FsbGJhY2spIHtcclxuXHJcbiAgICAvLyBnZXQgcmVzdGF1cmFudHMgZnJvbSBpbmRleGVkREJcclxuICAgIERCSGVscGVyLm9wZW5EYXRhYmFzZSgpLnRoZW4oZnVuY3Rpb24gKGRiKSB7XHJcbiAgICAgIGlmICghZGIpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH0gIGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudHMnLCAncmVhZHdyaXRlJylcclxuICAgICAgICAgICAgICAgICAub2JqZWN0U3RvcmUoJ3Jlc3RhdXJhbnRzJylcclxuICAgICAgICAgICAgICAgICAuZ2V0QWxsKCk7XHJcbiAgICAgIH1cclxuICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3RhdXJhbnRzKSB7XHJcbiAgICAgIGlmIChyZXN0YXVyYW50cy5sZW5ndGggPT09IDApIHJldHVybjtcclxuICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdGF1cmFudHMpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZmV0Y2goREJIZWxwZXIuUkVTVEFVUkFOVF9VUkwpXHJcbiAgICAudGhlbihcclxuICAgICAgZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnRmV0Y2ggSXNzdWUgLSBTdGF0dXMgQ29kZTogJyArIHJlc3BvbnNlLnN0YXR1cyk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXNwb25zZS5qc29uKCkudGhlbihmdW5jdGlvbiAocmVzdGF1cmFudHMpIHtcclxuXHJcbiAgICAgICAgICAvKiBBZGQgcmVzdGF1cmFudHMgdG8gaW5kZXhlZERCICovXHJcbiAgICAgICAgICBEQkhlbHBlci5vcGVuRGF0YWJhc2UoKS50aGVuKGZ1bmN0aW9uIChkYikge1xyXG4gICAgICAgICAgICBpZiAoIWRiKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGxldCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50cycsICdyZWFkd3JpdGUnKTtcclxuICAgICAgICAgICAgICBsZXQgc3RvcmVSZXN0YXVyYW50cyA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xyXG5cclxuICAgICAgICAgICAgICByZXN0YXVyYW50cy5mb3JFYWNoKGZ1bmN0aW9uIChyZXN0YXVyYW50KSB7XHJcbiAgICAgICAgICAgICAgICBzdG9yZVJlc3RhdXJhbnRzLnB1dChyZXN0YXVyYW50KTtcclxuICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgcmV0dXJuIHR4LmNvbXBsZXRlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXN0YXVyYW50cyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIClcclxuICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdGZXRjaCBFcnJvcjogJywgZXJyKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYSByZXN0YXVyYW50IGJ5IGl0cyBJRC5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlJZChpZCwgY2FsbGJhY2spIHtcclxuICAgIC8vIGZldGNoIGFsbCByZXN0YXVyYW50cyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcmVzdGF1cmFudCA9IHJlc3RhdXJhbnRzLmZpbmQociA9PiByLmlkID09IGlkKTtcclxuICAgICAgICBpZiAocmVzdGF1cmFudCkgeyAvLyBHb3QgdGhlIHJlc3RhdXJhbnRcclxuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnQpO1xyXG4gICAgICAgIH0gZWxzZSB7IC8vIFJlc3RhdXJhbnQgZG9lcyBub3QgZXhpc3QgaW4gdGhlIGRhdGFiYXNlXHJcbiAgICAgICAgICBjYWxsYmFjaygnUmVzdGF1cmFudCBkb2VzIG5vdCBleGlzdCcsIG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgdHlwZSB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHMgIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gY3Vpc2luZSB0eXBlXHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeU5laWdoYm9yaG9vZChuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBuZWlnaGJvcmhvb2RcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgYW5kIGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCByZXN1bHRzID0gcmVzdGF1cmFudHM7XHJcbiAgICAgICAgaWYgKGN1aXNpbmUgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IGN1aXNpbmVcclxuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG5laWdoYm9yaG9vZCAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgbmVpZ2hib3Job29kXHJcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLm5laWdoYm9yaG9vZCA9PSBuZWlnaGJvcmhvb2QpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0cyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIG5laWdoYm9yaG9vZHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoTmVpZ2hib3Job29kcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgbmVpZ2hib3Job29kcyBmcm9tIGFsbCByZXN0YXVyYW50c1xyXG4gICAgICAgIGNvbnN0IG5laWdoYm9yaG9vZHMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLm5laWdoYm9yaG9vZCk7XHJcblxyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gbmVpZ2hib3Job29kc1xyXG4gICAgICAgIGNvbnN0IHVuaXF1ZU5laWdoYm9yaG9vZHMgPSBuZWlnaGJvcmhvb2RzLmZpbHRlcigodiwgaSkgPT4gbmVpZ2hib3Job29kcy5pbmRleE9mKHYpID09IGkpO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHVuaXF1ZU5laWdoYm9yaG9vZHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCBjdWlzaW5lcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hDdWlzaW5lcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRzKChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgY3Vpc2luZXMgZnJvbSBhbGwgcmVzdGF1cmFudHNcclxuICAgICAgICBjb25zdCBjdWlzaW5lcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0uY3Vpc2luZV90eXBlKTtcclxuXHJcbiAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMgZnJvbSBjdWlzaW5lc1xyXG4gICAgICAgIGNvbnN0IHVuaXF1ZUN1aXNpbmVzID0gY3Vpc2luZXMuZmlsdGVyKCh2LCBpKSA9PiBjdWlzaW5lcy5pbmRleE9mKHYpID09IGkpO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHVuaXF1ZUN1aXNpbmVzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgICAqIEZldGNoIGFsbCByZXZpZXdzLlxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgZmV0Y2hSZXZpZXdzKGlkLCBjYWxsYmFjaykge1xyXG5cclxuICAgICAgLy8gZ2V0IHJldmlld3MgZnJvbSBpbmRleGVkREJcclxuICAgICAgREJIZWxwZXIub3BlbkRhdGFiYXNlKCkudGhlbihmdW5jdGlvbiAoZGIpIHtcclxuICAgICAgICBpZiAoIWRiKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfSAgZWxzZSB7XHJcbiAgICAgICAgICBsZXQgc3RvcmVSZXZpZXdzID0gZGIudHJhbnNhY3Rpb24oJ3Jldmlld3MnLCAncmVhZHdyaXRlJylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vYmplY3RTdG9yZSgncmV2aWV3cycpO1xyXG4gICAgICAgICAgbGV0IHJlc3RJbmRleCA9IHN0b3JlUmV2aWV3cy5pbmRleCgncmVzdGF1cmFudF9pZCcpO1xyXG4gICAgICAgICAgcmV0dXJuIHJlc3RJbmRleC5nZXRBbGwocGFyc2VJbnQoaWQpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJldmlld3MpIHtcclxuICAgICAgICBpZiAocmV2aWV3cy5sZW5ndGggPT09IDApIHJldHVybjtcclxuICAgICAgICBjYWxsYmFjayhudWxsLCByZXZpZXdzKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvKiBGZXRjaCByZXZpZXdzIGZyb20gbmV0d29yayAqL1xyXG4gICAgICBmZXRjaChgJHtEQkhlbHBlci5SRVZJRVdTX1VSTH0ke2lkfWApXHJcbiAgICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5qc29uKCkpXHJcbiAgICAgICAgICAgICAudGhlbihyZXZpZXdzID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICAvKiBBZGQgcmV2aWV3cyB0byBpbmRleGVkREIgKi9cclxuICAgICAgICAgICAgICAgIERCSGVscGVyLm9wZW5EYXRhYmFzZSgpLnRoZW4oZnVuY3Rpb24gKGRiKSB7XHJcbiAgICAgICAgICAgICAgICAgIGlmICghZGIpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jldmlld3MnLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN0b3JlUmV2aWV3cyA9IHR4Lm9iamVjdFN0b3JlKCdyZXZpZXdzJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldmlld3MuZm9yRWFjaChmdW5jdGlvbiAocmV2aWV3KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICBzdG9yZVJldmlld3MucHV0KHJldmlldyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0eC5jb21wbGV0ZTtcclxuICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmV2aWV3cyk7XHJcbiAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgIC5jYXRjaChlcnJvciA9PiBjYWxsYmFjayhgUmVxdWVzdCBmYWlsZWQuIFJldHVybmVkICR7ZXJyb3J9YCwgbnVsbCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBmZXRjaFRtcFJldmlld3MoaWQsIGNhbGxiYWNrKSB7XHJcblxyXG4gICAgICAvLyBnZXQgcmV2aWV3cyBmcm9tIGluZGV4ZWREQlxyXG4gICAgICBEQkhlbHBlci5vcGVuRGF0YWJhc2UoKS50aGVuKGZ1bmN0aW9uIChkYikge1xyXG4gICAgICAgIGlmICghZGIpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9ICBlbHNlIHtcclxuICAgICAgICAgIGxldCBzdG9yZVJldmlld3MgPSBkYi50cmFuc2FjdGlvbignc3luYy1yZXZpZXdzJywgJ3JlYWRvbmx5JylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vYmplY3RTdG9yZSgnc3luYy1yZXZpZXdzJyk7XHJcbiAgICAgICAgICBsZXQgcmVzdEluZGV4ID0gc3RvcmVSZXZpZXdzLmluZGV4KCdyZXN0YXVyYW50X2lkJyk7XHJcbiAgICAgICAgICByZXR1cm4gcmVzdEluZGV4LmdldEFsbChwYXJzZUludChpZCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSkudGhlbihmdW5jdGlvbiAocmV2aWV3cykge1xyXG4gICAgICAgIGlmIChyZXZpZXdzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJldmlld3MpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFBvc3QgcmV2aWV3cyB0byBEQlxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgcG9zdFJldmlldyhyZXZpZXcpIHtcclxuICAgICAgcmV0dXJuIERCSGVscGVyLm9wZW5EYXRhYmFzZSgpLnRoZW4oZnVuY3Rpb24gKGRiKSB7XHJcbiAgICAgICAgaWYgKCFkYikge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBsZXQgdHggPSBkYi50cmFuc2FjdGlvbignc3luYy1yZXZpZXdzJywgJ3JlYWR3cml0ZScpO1xyXG4gICAgICAgICAgbGV0IHN0b3JlUmV2aWV3cyA9IHR4Lm9iamVjdFN0b3JlKCdzeW5jLXJldmlld3MnKTtcclxuXHJcbiAgICAgICAgICBzdG9yZVJldmlld3MucHV0KHJldmlldyk7XHJcbiAgICAgICAgICByZXR1cm4gdHguY29tcGxldGU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHRvZ2dsZUZhdm9yaXRlKHJlc3RhdXJhbnRJZCwgdG9nZ2xlVmFsdWUpIHtcclxuICByZXR1cm4gREJIZWxwZXIub3BlbkRhdGFiYXNlKCkudGhlbihmdW5jdGlvbiAoZGIpIHtcclxuICAgIGlmICghZGIpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGV0IHN0b3JlUmVzdGF1cmFudHMgPSBkYi50cmFuc2FjdGlvbigncmVzdGF1cmFudHMnLCAncmVhZHdyaXRlJylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vYmplY3RTdG9yZSgncmVzdGF1cmFudHMnKTtcclxuICAgICAgbGV0IHJlc3RhdXJhbnRJbmRleCA9IHN0b3JlUmVzdGF1cmFudHMuaW5kZXgoJ3Jlc3QtaWQnKTtcclxuICAgICAgcmV0dXJuIHJlc3RhdXJhbnRJbmRleC5vcGVuQ3Vyc29yKCk7XHJcbiAgICB9XHJcbiAgfSkudGhlbihmdW5jdGlvbiB1cGRhdGVGYXZvcml0ZShjdXJzb3IpIHtcclxuXHJcbiAgICByZXN0YXVyYW50SWQgPSArcmVzdGF1cmFudElkO1xyXG5cclxuICAgIGlmICghY3Vyc29yKSByZXR1cm47XHJcblxyXG4gICAgaWYgKGN1cnNvci52YWx1ZS5pZCA9PT0gcmVzdGF1cmFudElkKSB7XHJcbiAgICAgIHZhciB1cGRhdGVEYXRhID0gY3Vyc29yLnZhbHVlO1xyXG5cclxuICAgICAgdXBkYXRlRGF0YS5pc19mYXZvcml0ZSA9IHRvZ2dsZVZhbHVlO1xyXG4gICAgICB2YXIgcmVxdWVzdCA9IGN1cnNvci51cGRhdGUodXBkYXRlRGF0YSk7XHJcbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfTtcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIGN1cnNvci5jb250aW51ZSgpLnRoZW4odXBkYXRlRmF2b3JpdGUpO1xyXG5cclxuICB9KS50aGVuKGZ1bmN0aW9uICgpIHtcclxuXHJcbiAgICAgIGNvbnN0IHVybCA9IGBodHRwOi8vbG9jYWxob3N0OjEzMzcvcmVzdGF1cmFudHMvJHtyZXN0YXVyYW50SWR9Lz9pc19mYXZvcml0ZT0ke3RvZ2dsZVZhbHVlfWA7XHJcblxyXG4gICAgICBmZXRjaCh1cmwsIHtcclxuICAgICAgICBtZXRob2Q6ICdQVVQnLFxyXG4gICAgICB9KS50aGVuKChyZXNwb25zZSkgPT4gcmVzcG9uc2UuanNvbigpXHJcbiAgICAgICkuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIGZldGNoaW5nIGlzX2Zhdm9yaXRlOiAnICsgZXJyb3IpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfSk7XHJcbn1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBwYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgdXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGAuL3Jlc3RhdXJhbnQuaHRtbD9pZD0ke3Jlc3RhdXJhbnQuaWR9YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IGltYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuICAgIHJldHVybiAoYC9pbWcvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGh9LndlYnBgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gKiBSZXN0YXVyYW50IHJlc3BvbnNpdmUgaW1hZ2VzIHNvdXJjZSBzZXQuXHJcbiAqL1xyXG5zdGF0aWMgaW1hZ2VSZXNwb25zaXZlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICBjb25zdCBzY2FsZTF4ID0gJzMyMCc7XHJcbiAgICBjb25zdCBzY2FsZTFfNXggPSAnNDgwJztcclxuICAgIGNvbnN0IHNjYWxlMnggPSAnNjQwJztcclxuICAgIGNvbnN0IHNjYWxlM3ggPSAnODAwJztcclxuXHJcbiAgICByZXR1cm4gKFxyXG4gICAgICAgIGAvaW1nX3Jlc3BvbnNpdmUvJHtyZXN0YXVyYW50LmlkfS0ke3NjYWxlMXh9LndlYnAgJHtzY2FsZTF4fXcsXHJcbiAgICAgICAgL2ltZ19yZXNwb25zaXZlLyR7cmVzdGF1cmFudC5pZH0tJHtzY2FsZTFfNXh9LndlYnAgJHtzY2FsZTFfNXh9dyxcclxuICAgICAgICAvaW1nX3Jlc3BvbnNpdmUvJHtyZXN0YXVyYW50LmlkfS0ke3NjYWxlMnh9LndlYnAgJHtzY2FsZTJ4fXcsXHJcbiAgICAgICAgL2ltZ19yZXNwb25zaXZlLyR7cmVzdGF1cmFudC5pZH0tJHtzY2FsZTN4fS53ZWJwICR7c2NhbGUzeH13YCk7XHJcbn1cclxuXHJcbiAgLyoqXHJcbiAgICogTWFwIG1hcmtlciBmb3IgYSByZXN0YXVyYW50LlxyXG4gICAqL1xyXG4gIHN0YXRpYyBtYXBNYXJrZXJGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG1hcCkge1xyXG4gICAgY29uc3QgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgIHBvc2l0aW9uOiByZXN0YXVyYW50LmxhdGxuZyxcclxuICAgICAgdGl0bGU6IHJlc3RhdXJhbnQubmFtZSxcclxuICAgICAgdXJsOiBEQkhlbHBlci51cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpLFxyXG4gICAgICBtYXA6IG1hcCxcclxuICAgICAgYW5pbWF0aW9uOiBnb29nbGUubWFwcy5BbmltYXRpb24uRFJPUCxcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG1hcmtlcjtcclxuICB9XHJcblxyXG59XHJcbiIsImxldCByZXN0YXVyYW50cyxcclxuICBuZWlnaGJvcmhvb2RzLFxyXG4gIGN1aXNpbmVzXHJcbnZhciBtYXBcclxudmFyIG1hcmtlcnMgPSBbXVxyXG5cclxubGV0IG9ic2VydmVyID0gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKGNoYW5nZXMgPT4ge1xyXG4gIGZvciAoY29uc3QgY2hhbmdlIG9mIGNoYW5nZXMpIHtcclxuICAgIGlmIChjaGFuZ2UuaW50ZXJzZWNpb25SYXRpb24gPj0gMC45KSB7XHJcbiAgICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCBkYXRhKSA9PiB7XHJcbiAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZmlsbFJlc3RhdXJhbnRIVE1MKGRhdGEpXHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbn0sXHJcbiAge1xyXG4gICAgdGhyZXNob2xkOiBbMC45XVxyXG4gIH1cclxuKTtcclxuXHJcbm9ic2VydmVyLm9ic2VydmUoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnRzLWxpc3QnKSk7XHJcblxyXG4vKlxyXG5TZXR0aW5nIHBob3RvZ3JhcGhzIGFsdHMqL1xyXG5cclxuY29uc3QgcGhvdG9ncmFwaEFsdHMgPSB7XHJcblx0MTogXCJTZXJldmFsIGdyb3VwcyBvZiBwZW9wbGUgaGF2aW5nIHF1YWxpdHkgdGltZSBhdCBhIHJlc3RhdXJhbnQuXCIsXHJcblx0MjogXCJBIGxvdmVseSBtYXJnZXJpdHRhIHBpenphXCIsXHJcblx0MzogXCJBbiBlbXB0eSByZXN0YXVyYW50IHNldHRpbmcgd2hpY2ggaGFzIGhlYXRlcnNcIixcclxuXHQ0OiBcIkEgY29ybmVyIHNob3Qgb2YgdGhlIG91dHNpZGUgb2YgdGhlIHJlc3RhdXJhdC5cIixcclxuXHQ1OiBcIkEgY3Jvd2RlZCByZXN0YXVyYW50IGFuZCBzdGFmZiBzZXJ2aW5nIGZvb2QgZnJvbSBiZWhpbmQgdGhlIGJhci5cIixcclxuXHQ2OiBcIlJlc3RhdXJhbnQgd2l0aCB3b29kZW4gdGFibGVzLCBjaGFyaXMsIGFuZCBhIFVTIGZsYWcgYXMgYSB3YWxsIGRlY29yYXRpb25cIixcclxuXHQ3OiBcImEgZG9nIHdhdGNoaW5nIGZyb20gdGhlIG91dHNpZGUgb2YgYSBjcm93ZGVkIGJ1cmdlciBzaG9wLCBhY2NvbXBhbmllZCBieSB0d28gbWVuLlwiLFxyXG5cdDg6IFwiQ2xvc2UgdXAgb2YgdGhlIGR1dGNoIHJlc3RhdXJhbnQgbG9nbyBiZXNpZGUgYSBmbG93ZXJpbmcgdHJlZVwiLFxyXG5cdDk6IFwiQmxhY2sgYW5kIHdoaXRlIHBpY3R1cmUgb2YgcGVvcGxlIGVhdGluZyBhdCBhbiBhc2lhbiByZXN0YXVyYXQuXCIsXHJcblx0MTA6IFwiRW1wdHkgcmVzdGF1cmFudCdzIHdoaXRlIGNoYWlycywgd2FsbHMgYW5kIGNlaWxpbmdzLlwiXHJcbn07XHJcblxyXG5cclxuXHJcbi8qKlxyXG4gKiBGZXRjaCBuZWlnaGJvcmhvb2RzIGFuZCBjdWlzaW5lcyBhcyBzb29uIGFzIHRoZSBwYWdlIGlzIGxvYWRlZC5cclxuICovXHJcbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoZXZlbnQpID0+IHtcclxuICBmZXRjaE5laWdoYm9yaG9vZHMoKTtcclxuICBmZXRjaEN1aXNpbmVzKCk7XHJcbn0pO1xyXG5cclxuLyoqXHJcbiAqIEZldGNoIGFsbCBuZWlnaGJvcmhvb2RzIGFuZCBzZXQgdGhlaXIgSFRNTC5cclxuICovXHJcbmZldGNoTmVpZ2hib3Job29kcyA9ICgpID0+IHtcclxuICBEQkhlbHBlci5mZXRjaE5laWdoYm9yaG9vZHMoKGVycm9yLCBuZWlnaGJvcmhvb2RzKSA9PiB7XHJcbiAgICBpZiAoZXJyb3IpIHsgLy8gR290IGFuIGVycm9yXHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2VsZi5uZWlnaGJvcmhvb2RzID0gbmVpZ2hib3Job29kcztcclxuICAgICAgZmlsbE5laWdoYm9yaG9vZHNIVE1MKCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBTZXQgbmVpZ2hib3Job29kcyBIVE1MLlxyXG4gKi9cclxuZmlsbE5laWdoYm9yaG9vZHNIVE1MID0gKG5laWdoYm9yaG9vZHMgPSBzZWxmLm5laWdoYm9yaG9vZHMpID0+IHtcclxuICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbmVpZ2hib3Job29kcy1zZWxlY3QnKTtcclxuICBuZWlnaGJvcmhvb2RzLmZvckVhY2gobmVpZ2hib3Job29kID0+IHtcclxuICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xyXG4gICAgb3B0aW9uLmlubmVySFRNTCA9IG5laWdoYm9yaG9vZDtcclxuICAgIG9wdGlvbi52YWx1ZSA9IG5laWdoYm9yaG9vZDtcclxuICAgIHNlbGVjdC5hcHBlbmQob3B0aW9uKTtcclxuICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEZldGNoIGFsbCBjdWlzaW5lcyBhbmQgc2V0IHRoZWlyIEhUTUwuXHJcbiAqL1xyXG5mZXRjaEN1aXNpbmVzID0gKCkgPT4ge1xyXG4gIERCSGVscGVyLmZldGNoQ3Vpc2luZXMoKGVycm9yLCBjdWlzaW5lcykgPT4ge1xyXG4gICAgaWYgKGVycm9yKSB7IC8vIEdvdCBhbiBlcnJvciFcclxuICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzZWxmLmN1aXNpbmVzID0gY3Vpc2luZXM7XHJcbiAgICAgIGZpbGxDdWlzaW5lc0hUTUwoKTtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIFNldCBjdWlzaW5lcyBIVE1MLlxyXG4gKi9cclxuZmlsbEN1aXNpbmVzSFRNTCA9IChjdWlzaW5lcyA9IHNlbGYuY3Vpc2luZXMpID0+IHtcclxuICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3Vpc2luZXMtc2VsZWN0Jyk7XHJcblxyXG4gIGN1aXNpbmVzLmZvckVhY2goY3Vpc2luZSA9PiB7XHJcbiAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKTtcclxuICAgIG9wdGlvbi5pbm5lckhUTUwgPSBjdWlzaW5lO1xyXG4gICAgb3B0aW9uLnZhbHVlID0gY3Vpc2luZTtcclxuICAgIHNlbGVjdC5hcHBlbmQob3B0aW9uKTtcclxuICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEluaXRpYWxpemUgR29vZ2xlIG1hcCwgY2FsbGVkIGZyb20gSFRNTC5cclxuICovXHJcbiB3aW5kb3cuaW5pdE1hcCA9ICgpID0+IHtcclxuICBsZXQgbG9jID0ge1xyXG4gICAgbGF0OiA0MC43MjIyMTYsXHJcbiAgICBsbmc6IC03My45ODc1MDFcclxuICB9O1xyXG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAnKTtcclxuICBzZWxmLm1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcCcpLCB7XHJcbiAgICB6b29tOiAxMixcclxuICAgIGNlbnRlcjogbG9jLFxyXG4gICAgc2Nyb2xsd2hlZWw6IGZhbHNlXHJcbiAgfSk7XHJcblxyXG4gIHVwZGF0ZVJlc3RhdXJhbnRzKCk7XHJcbn1cclxuXHJcbi8qKlxyXG5TaG93IG1hcCBidXR0b25cclxuKi9cclxuY2FsbE1hcCA9XHJcbmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXBUb2dnbGUnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgaWYgKChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFwLWNvbnRhaW5lcicpLnN0eWxlLmRpc3BsYXkpID09PSAnYmxvY2snKSB7XHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFwLWNvbnRhaW5lcicpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XHJcbiAgICB3aW5kb3cuaW5pdE1hcCgpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFwLWNvbnRhaW5lcicpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xyXG4gIH1cclxufSk7XHJcbi8qKlxyXG4gKiBVcGRhdGUgcGFnZSBhbmQgbWFwIGZvciBjdXJyZW50IHJlc3RhdXJhbnRzLlxyXG4gKi9cclxudXBkYXRlUmVzdGF1cmFudHMgPSAoKSA9PiB7XHJcbiAgY29uc3QgY1NlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlzaW5lcy1zZWxlY3QnKTtcclxuICBjb25zdCBuU2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25laWdoYm9yaG9vZHMtc2VsZWN0Jyk7XHJcblxyXG4gIGNvbnN0IGNJbmRleCA9IGNTZWxlY3Quc2VsZWN0ZWRJbmRleDtcclxuICBjb25zdCBuSW5kZXggPSBuU2VsZWN0LnNlbGVjdGVkSW5kZXg7XHJcblxyXG4gIGNvbnN0IGN1aXNpbmUgPSBjU2VsZWN0W2NJbmRleF0udmFsdWU7XHJcbiAgY29uc3QgbmVpZ2hib3Job29kID0gblNlbGVjdFtuSW5kZXhdLnZhbHVlO1xyXG5cclxuICBEQkhlbHBlci5mZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICBpZiAoZXJyb3IpIHsgLy8gR290IGFuIGVycm9yIVxyXG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJlc2V0UmVzdGF1cmFudHMocmVzdGF1cmFudHMpO1xyXG4gICAgICBmaWxsUmVzdGF1cmFudHNIVE1MKCk7XHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG5cclxuLyoqXHJcbiAqIENsZWFyIGN1cnJlbnQgcmVzdGF1cmFudHMsIHRoZWlyIEhUTUwgYW5kIHJlbW92ZSB0aGVpciBtYXAgbWFya2Vycy5cclxuICovXHJcbnJlc2V0UmVzdGF1cmFudHMgPSAocmVzdGF1cmFudHMpID0+IHtcclxuICAvLyBSZW1vdmUgYWxsIHJlc3RhdXJhbnRzXHJcbiAgc2VsZi5yZXN0YXVyYW50cyA9IFtdO1xyXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnRzLWxpc3QnKTtcclxuICB1bC5pbm5lckhUTUwgPSAnJztcclxuXHJcbiAgLy8gUmVtb3ZlIGFsbCBtYXAgbWFya2Vyc1xyXG4gIHNlbGYubWFya2Vycy5mb3JFYWNoKG0gPT4gbS5zZXRNYXAobnVsbCkpO1xyXG4gIHNlbGYubWFya2VycyA9IFtdO1xyXG4gIHNlbGYucmVzdGF1cmFudHMgPSByZXN0YXVyYW50cztcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSBhbGwgcmVzdGF1cmFudHMgSFRNTCBhbmQgYWRkIHRoZW0gdG8gdGhlIHdlYnBhZ2UuXHJcbiAqL1xyXG5maWxsUmVzdGF1cmFudHNIVE1MID0gKHJlc3RhdXJhbnRzID0gc2VsZi5yZXN0YXVyYW50cykgPT4ge1xyXG4gIGNvbnN0IHVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Jlc3RhdXJhbnRzLWxpc3QnKTtcclxuICByZXN0YXVyYW50cy5mb3JFYWNoKHJlc3RhdXJhbnQgPT4ge1xyXG4gICAgdWwuYXBwZW5kKGNyZWF0ZVJlc3RhdXJhbnRIVE1MKHJlc3RhdXJhbnQpKTtcclxuICB9KTtcclxuICBhZGRNYXJrZXJzVG9NYXAoKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZSByZXN0YXVyYW50IEhUTUwuXHJcbiAqL1xyXG5jcmVhdGVSZXN0YXVyYW50SFRNTCA9IChyZXN0YXVyYW50KSA9PiB7XHJcbiAgY29uc3QgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xyXG4gIGxpLnRhYkluZGV4ID0nMCc7XHJcblxyXG4gIGNvbnN0IGltYWdlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7XHJcbiAgaW1hZ2UuY2xhc3NOYW1lID0gJ3Jlc3RhdXJhbnQtaW1nJztcclxuICBpbWFnZS5zcmMgPSBEQkhlbHBlci5pbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCk7XHJcbiAgaW1hZ2Uuc3Jjc2V0ID0gREJIZWxwZXIuaW1hZ2VSZXNwb25zaXZlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KTtcclxuICBpbWFnZS5hbHQgPSBwaG90b2dyYXBoQWx0c1tyZXN0YXVyYW50LmlkXTtcclxuICBsaS5hcHBlbmQoaW1hZ2UpO1xyXG5cclxuICBjb25zdCBuYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDInKTtcclxuICBuYW1lLmlubmVySFRNTCA9IHJlc3RhdXJhbnQubmFtZTtcclxuICBsaS5hcHBlbmQobmFtZSk7XHJcblxyXG4gIGNvbnN0IG5laWdoYm9yaG9vZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcclxuICBuZWlnaGJvcmhvb2QuaW5uZXJIVE1MID0gcmVzdGF1cmFudC5uZWlnaGJvcmhvb2Q7XHJcbiAgbGkuYXBwZW5kKG5laWdoYm9yaG9vZCk7XHJcblxyXG4gIGNvbnN0IGFkZHJlc3MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XHJcbiAgYWRkcmVzcy5pbm5lckhUTUwgPSByZXN0YXVyYW50LmFkZHJlc3M7XHJcbiAgbGkuYXBwZW5kKGFkZHJlc3MpO1xyXG5cclxuICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgd3JhcHBlci5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ3dyYXBwZXInKTtcclxuICBsaS5hcHBlbmQod3JhcHBlcik7XHJcblxyXG4gIGNvbnN0IG1vcmUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XHJcbiAgbW9yZS5pbm5lckhUTUwgPSAnVmlldyBEZXRhaWxzJztcclxuICBtb3JlLmhyZWYgPSBEQkhlbHBlci51cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpO1xyXG4gIHdyYXBwZXIuYXBwZW5kKG1vcmUpXHJcblxyXG4gIGNvbnN0IGZhdm9yaXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaScpO1xyXG4gIGNvbnN0IGlzRmF2b3JpdGUgPSByZXN0YXVyYW50LmlzX2Zhdm9yaXRlID09ICd0cnVlJyA/ICdmYXMnIDogJ2Zhcic7IC8vIEFQSSBQVVQgY29udmVydHMgdHJ1ZSBpbnRvICd0cnVlJy4uLlxyXG4gIGZhdm9yaXRlLnNldEF0dHJpYnV0ZSgnaWQnLCBgcmVzdCR7cmVzdGF1cmFudC5pZH1gKTtcclxuICBmYXZvcml0ZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgYCR7aXNGYXZvcml0ZX0gZmEtaGVhcnQgZmEtM3hgKTtcclxuICBmYXZvcml0ZS5zZXRBdHRyaWJ1dGUoJ3RhYmluZGV4JywgJzAnKTtcclxuICBmYXZvcml0ZS5zZXRBdHRyaWJ1dGUoJ3JvbGUnLCAnYnV0dG9uJyk7XHJcbiAgaWYgKHJlc3RhdXJhbnQuaXNfZmF2b3JpdGUgPT0gJ3RydWUnKSB7XHJcbiAgICBmYXZvcml0ZS5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCBgVW5tYXJrICR7cmVzdGF1cmFudC5uYW1lfSBhcyBmYXZvcml0ZWApO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBmYXZvcml0ZS5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCBgTWFyayAke3Jlc3RhdXJhbnQubmFtZX0gYXMgZmF2b3JpdGVgKTtcclxuICB9XHJcblxyXG4gIGZhdm9yaXRlLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgY29uc3QgcmVzdElkID0gZmF2b3JpdGUuZ2V0QXR0cmlidXRlKCdpZCcpO1xyXG4gICAgdG9nZ2xlRmF2KHJlc3RJZCwgcmVzdGF1cmFudC5uYW1lKTtcclxuICB9KTtcclxuICBmYXZvcml0ZS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpID0+IHtcclxuICAgIGlmIChlLmtleUNvZGUgPT09IDEzKSB7IC8vID0gZW50ZXIga2V5XHJcbiAgICAgIGNvbnN0IHJlc3RJZCA9IGZhdm9yaXRlLmdldEF0dHJpYnV0ZSgnaWQnKTtcclxuICAgICAgdG9nZ2xlRmF2KHJlc3RJZCwgcmVzdGF1cmFudC5uYW1lKTtcclxuICAgIH1cclxuICB9KTtcclxuICB3cmFwcGVyLmFwcGVuZChmYXZvcml0ZSk7XHJcblxyXG4gIHJldHVybiBsaVxyXG59O1xyXG5cclxudG9nZ2xlRmF2ID0gKHJlc3RJZCwgcmVzdE5hbWUpID0+IHtcclxuICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocmVzdElkKTtcclxuICBjb25zdCBzZXRUb2dnbGUgPSBlbGVtZW50LmNsYXNzTGlzdC5jb250YWlucygnZmFyJyk7XHJcbiAgZWxlbWVudC5jbGFzc0xpc3QudG9nZ2xlKCdmYXInKTtcclxuICBlbGVtZW50LmNsYXNzTGlzdC50b2dnbGUoJ2ZhcycpO1xyXG4gIGlmIChzZXRUb2dnbGUpIHtcclxuICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgYE1hcmsgJHtyZXN0TmFtZX0gYXMgZmF2b3JpdGVgKTtcclxuICB9IGVsc2Uge1xyXG4gICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2FyaWEtbGFiZWwnLCBgVW5tYXJrICR7cmVzdE5hbWV9IGFzIGZhdm9yaXRlYCk7XHJcbiAgfVxyXG5cclxuICBEQkhlbHBlci50b2dnbGVGYXZvcml0ZShyZXN0SWQuc2xpY2UoNCksIHNldFRvZ2dsZSkudGhlbigoKSA9PiB7XHJcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgdXBkYXRlUmVzdGF1cmFudHMoKTtcclxuICAgIH0sIDIwMCk7XHJcbiAgfSk7XHJcblxyXG59O1xyXG5cclxuLyoqXHJcbiAqIEFkZCBtYXJrZXJzIGZvciBjdXJyZW50IHJlc3RhdXJhbnRzIHRvIHRoZSBtYXAuXHJcbiAqL1xyXG5hZGRNYXJrZXJzVG9NYXAgPSAocmVzdGF1cmFudHMgPSBzZWxmLnJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgcmVzdGF1cmFudHMuZm9yRWFjaChyZXN0YXVyYW50ID0+IHtcclxuICAgIC8vIEFkZCBtYXJrZXIgdG8gdGhlIG1hcFxyXG4gICAgY29uc3QgbWFya2VyID0gREJIZWxwZXIubWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBzZWxmLm1hcCk7XHJcbiAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsICdjbGljaycsICgpID0+IHtcclxuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBtYXJrZXIudXJsXHJcbiAgICB9KTtcclxuICAgIHNlbGYubWFya2Vycy5wdXNoKG1hcmtlcik7XHJcbiAgfSk7XHJcbn1cclxuXHJcblxyXG5pZiAobmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIpIHtcclxuICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3Rlcignc3cuanMnKVxyXG4gICAgLnRoZW4oKCkgPT4gY29uc29sZS5sb2coJ1Bhc3NlZCBUZXN0JykpXHJcbn07XHJcbiIsIlxyXG4vKipcclxuICogUmVnaXN0ZXIgYSBzZXJ2aWNlV29ya2VyXHJcbiAqL1xyXG5yZWdpc3RlclNlcnZpY2VXb3JrZXIgPSAoKSA9PiB7XHJcbiAgICAvL2NoZWNrIGlmIHNlcnZpY2VXb3JrZXIgaXMgc3VwcG9ydGVkLCBvdGhlcndpc2UgcmV0dXJuXHJcbiAgICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSByZXR1cm47XHJcblxyXG4gICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoJy9zdy5qcycpLmNhdGNoKGZ1bmN0aW9uKCl7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwiU29tZXRoaW5nIHdlbnQgd3JvbmcuIFNlcnZpY2VXb3JrZXIgbm90IHJlZ2lzdGVyZWRcIik7XHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuICByZWdpc3RlclNlcnZpY2VXb3JrZXIoKTtcclxuIl19
